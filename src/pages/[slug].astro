---
// @ts-nocheck
// 1️⃣ Tell Astro which pages to generate
export async function getStaticPaths() {
  // 1️⃣ Fetch all pages from WordPress
  const response = await fetch(`${import.meta.env.WPGRAPHQL_URL}`, {
    method: "POST",
    headers: { "content-type": "application/json" },
    body: JSON.stringify({
      query: `
        query AllPages {
          pages(first: 9999) {
            edges {
              node {
                slug
              }
            }
          }
        }
      `,
    }),
  });

  const { data } = await response.json();
  const allPages = data.pages.edges;

  // 2️⃣ Define static/locked slugs
  const staticSlugs = [
    "contact",
    "about-us",
    "news-resources",
    "our-services",
    "home",
    "", // covers root/front page
  ];

  // 3️⃣ Filter out static slugs so they don't generate [slug] routes
  const dynamicPages = allPages.filter(
    ({ node }) => !staticSlugs.includes(node.slug),
  );

  // 4️⃣ Map to Astro paths
  return dynamicPages.map(({ node }) => ({
    params: { slug: node.slug },
  }));
}

const pageResponse = await fetch(`${import.meta.env.WPGRAPHQL_URL}`, {
  method: "POST",
  headers: { "content-type": "application/json" },
  body: JSON.stringify({
    query: `
      query SinglePage($slug: ID!) {
        page(id: $slug, idType: URI) {
          slug
          template {
            templateName
          }
        }
      }
    `,
    variables: { slug: `/${slug}/` },
  }),
});

const { data } = await pageResponse.json();
const page = data.page;
const { slug } = Astro.props;

// Dynamic import based on template name
const templateName = page?.template?.templateName?.toLowerCase() ?? "default";
let TemplateComponent;

switch (true) {
  case templateName.includes("home"):
    TemplateComponent = (await import("../templates/HomeTemplate.astro"))
      .default;
    break;
  case templateName.includes("about"):
    TemplateComponent = (await import("../templates/AboutTemplate.astro"))
      .default;
    break;
  default:
    TemplateComponent = (await import("../templates/DefaultTemplate.astro"))
      .default;
}
---

<TemplateComponent slug={page.slug} />
